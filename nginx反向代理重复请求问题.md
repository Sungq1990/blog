---
title: nginx反向代理重复请求问题
date: 2022-06-02 17:55:00
tags: nginx 反向代理
---

```
  今天发现公司一个发邮件的接口执行了两次，通过日志发现是http请求请求了2次，
但是实际上用户只操作了1次。并且第2次请求距离第1次基本上有60秒的间隔，所以
怀疑是nginx配置的问题。经过百度发现是nginx反向代理的问题。
  由于这个接口需要发Excel邮件，所以执行时间会比较长，肯定是超过60秒的。
nginx反向代理当一台机器超过设置的超时时间还没返回时，会把请求发送到另外一台
机器上重试，这是nginx的容错机制。
  如何解决,主要是nginx3个配置。
  proxy_connect_timeout:超时时间
  proxy_next_upstream:定义了什么情况下进⾏重试
  proxy_next_upstream_tries:重试的次数
  至于如何解决这个问题就需要结合业务自己做处理了，直接去掉这个机制肯定是不行的，
我这边的做法是将这种耗时请求都异步处理了。
```
